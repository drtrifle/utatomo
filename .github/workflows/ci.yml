name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. üß™ CI JOB: Build, Test, and Upload Artifact
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        # ‚úÖ ACTION UPDATE: actions/checkout is now at v4
        uses: actions/checkout@v4 

      - name: Set up Node.js
        # actions/setup-node is already at v4, but v3 is fine too.
        uses: actions/setup-node@v3 
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run CI Checks
        run: |
          npm run lint
          npm run type-check
          npm test

      - name: Build project
        run: npm run build
      
      # ‚¨ÜÔ∏è ARTIFACT UPLOAD: Using the new v4 version
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-dist
          path: ./dist 

  # 2. üöÄ CD JOB: Download Artifact and Deploy
  deploy:
    # Requires the CI job to succeed first
    needs: build-and-test 
    
    # Only runs when pushing to the main branch
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      # ‚¨áÔ∏è ARTIFACT DOWNLOAD: Using the new v4 version
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: website-dist
          # In v4, you no longer specify the path in the download, 
          # it downloads to a folder matching the artifact name by default, 
          # but setting `path: ./dist` is the easiest way to replicate v3 behavior.
          path: ./dist 

      - name: Deploy to GitHub Pages
        # ‚úÖ DEPLOY ACTION UPDATE: Updated to v4
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # The path must be relative to the runner's working directory.
          publish_dir: ./dist